---
title: Servir medios adaptativos usando Service Workers
date: "2019-06-17"
spoiler:
  Todos hemos experimentado cómo visitar un sitio web a través de una conexión
  de red lenta suele tardar una eternidad en cargarse. Vamos a explorar cómo
  cargar diferentes contenidos multimedia utilizando la API de Información de
  Red.
tags:
  - javascript
  - service-workers
  - performance
---

_Haciendo pair con [@Ester Martí](https://github.com/estermv)_

Visitar un sitio web con una conexión de red lenta tarda una eternidad en
cargar, haciendo la experiencia dolorosa o imposible.

Los desarrolladores web a menudo olvidan el rendimiento de carga mientras añaden
características llamativas. Pero los usuarios probablemente navegan en
dispositivos móviles de gama media o baja con conexiones 3G como máximo--no el
último MacBook Pro con fibra gigabit.

> [En 2018, el 52.2% de todas las páginas web globales se sirvieron a teléfonos móviles.](https://www.statista.com/statistics/241462/global-mobile-phone-website-traffic-share/)

El rendimiento importa, y la entrega de medios consume más recursos. Adaptaremos
la entrega de medios basada en la conexión de red usando la
[API de Información de Red](http://wicg.github.io/netinfo/). Esto mejora un
experimento que construí con [@Eduardo Aquiles](https://twitter.com/eduaquiles)
como componente de React, similar al artículo de [Max Böck](https://mxb.dev/)
sobre
[componentes conscientes de la conexión](https://mxb.dev/blog/connection-aware-components/)--pero
usando service workers.

## La API de Información de Red

La API de Información de Red es un borrador de especificación que expone
información de conexión del dispositivo a JavaScript.

La interfaz proporciona varios atributos de red. Los más relevantes aquí:

- **type:** El
  [tipo de conexión](http://wicg.github.io/netinfo/#dfn-connection-type) que el
  agente de usuario está utilizando. (p.ej. ‘wifi’, ‘cellular’, ‘ethernet’,
  etc.)
- **effectiveType** El
  [tipo de conexión efectiva](http://wicg.github.io/netinfo/#dfn-effective-connection-type)
  que se determina utilizando una combinación de
  [rtt](http://wicg.github.io/netinfo/#dom-networkinformation-rtt) y
  [downlink](http://wicg.github.io/netinfo/#dom-networkinformation-downlink)
  observados recientemente. (_[ver tabla](#effectivetype-values)_)
- **saveData** Indica cuando el usuario solicitó un uso reducido de datos.

### valores de effectiveType

<table>
  <thead>
    <tr>
      <th>ECT</th>
      <th>RTT Mínimo (ms)</th>
      <th>Downlink Máximo (Kbps)</th>
      <th>Explicación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td data-column="ECT">slow‑2g</td>
      <td data-column="RTT">2000</td>
      <td data-column="Downlink">50</td>
      <td data-column="Explicación">
        La red es adecuada solo para transferencias pequeñas como páginas de
        solo texto.
      </td>
    </tr>
    <tr>
      <td data-column="ECT">2g</td>
      <td data-column="RTT">1400</td>
      <td data-column="Downlink">70</td>
      <td data-column="Explicación">
        La red es adecuada para transferencias de imágenes pequeñas.
      </td>
    </tr>
    <tr>
      <td data-column="ECT">3g</td>
      <td data-column="RTT">270</td>
      <td data-column="Downlink">700</td>
      <td data-column="Explicación">
        La red es adecuada para transferencias de activos grandes como imágenes
        de alta resolución, audio y vídeo SD.
      </td>
    </tr>
    <tr>
      <td data-column="ECT">4g</td>
      <td data-column="RTT">0</td>
      <td data-column="Downlink">∞</td>
      <td data-column="Explicación">
        La red es adecuada para vídeo HD, vídeo en tiempo real, etc.
      </td>
    </tr>
  </tbody>
  <caption align="bottom">
    Tabla de{" "}
    <a href="http://wicg.github.io/netinfo/#dfn-effective-connection-type">
      tipos de conexión efectiva (ECT)
    </a>
  </caption>
</table>

### Soporte del navegador

La API carece de soporte completo del navegador pero funciona en los
[navegadores móviles más populares](https://caniuse.com/#feat=netinfo)--donde
esta técnica tiene mayor impacto.

![Soporte del navegador para la API de Información de Red](/images/caniuse.png)

De hecho, el 70% de los usuarios móviles tienen esta API habilitada en su
dispositivo.

## Servir Medios Adaptativos

Serviremos diferentes recursos multimedia basados en `effectiveType`.
"Diferentes medios" podría significar cambiar entre vídeo HD, imagen HD o imagen
de baja calidad, como sugiere
[Addy Osmani](https://addyosmani.com/blog/adaptive-serving/).

Este ejemplo usa diferentes niveles de compresión para la misma imagen.

Primero, obtén la calidad adecuada basada en las condiciones de red:

```javascript
function getMediaQuality() {
  const connection =
    navigator.connection ||
    navigator.mozConnection ||
    navigator.webkitConnection;

  if (!connection) {
    return "medium";
  }

  switch (connection.effectiveType) {
    case "slow-2g":
    case "2g":
      return "low";
    case "3g":
      return "medium";
    case "4g":
      return "high";
    default:
      return "low";
  }
}
```

Imagina un servidor de imágenes que acepta un parámetro **quality** (`low`,
`medium` o `high`). Establece la calidad en el atributo `src`:

```html
<img src="http://images.magarcia.io/cute_cat?quality=low" alt="Gato lindo" />
```

```javascript
const images = document.querySelectorAll("img");
images.forEach((img) => {
  img.src = img.src.replace("low", getMediaQuality());
});
```

La calidad por defecto es `low`, así que los dispositivos cargan primero la
imagen de baja calidad, luego mejoran en conexiones rápidas.

El JavaScript obtiene todas las imágenes y reemplaza el parámetro de calidad
según `getMediaQuality`. Para calidad `low`, no hay peticiones adicionales. Para
`medium` o `high`, ocurren dos peticiones: una para `low` al analizar la
etiqueta `img`, otra para mejor calidad cuando ejecuta JavaScript.

Esto mejora los tiempos de carga en redes lentas pero duplica las peticiones en
conexiones rápidas, consumiendo datos extra.

## Usando Service Workers

Los
[service workers](https://developers.google.com/web/fundamentals/primers/service-workers/)
resuelven el problema de doble petición interceptando las peticiones del
navegador y reemplazándolas con la calidad apropiada.

Primero, registra el service worker:

```javascript
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("/sw.js").then(
      function (registration) {
        console.log(
          "Registro de ServiceWorker exitoso con alcance: ",
          registration.scope,
        );
      },
      function (err) {
        console.log("Registro de ServiceWorker fallido: ", err);
      },
    );
  });
}
```

Añade un listener del evento fetch que añade el parámetro de calidad correcto a
las peticiones de imágenes:

```javascript
self.addEventListener("fetch", function (event) {
  if (/\.jpg$|.png$|.webp$/.test(event.request.url)) {
    const url = event.request.url + `?quality=${getMediaQuality()}`;
    event.respondWith(fetch(url));
  }
});
```

Ahora omite el parámetro de calidad de las etiquetas `img`--el service worker lo
gestiona:

```html
<img src=“http://images.magarcia.io/cute_cat” alt=“Gato lindo”/>
```

## El código

Encuentra el código completo y más limpio en
[este repositorio de GitHub](https://github.com/estermv/adaptative-media-serving).

## Lectura Adicional

- [Network Information API](http://wicg.github.io/netinfo/)
- [Network Information API - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API)
